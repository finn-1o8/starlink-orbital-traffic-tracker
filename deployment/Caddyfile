# Main domain - Landing page
karmanlab.org, www.karmanlab.org {
    # Tracker routes - strip /tracker prefix before forwarding
    handle /tracker* {
        uri strip_prefix /tracker
        reverse_proxy tracker-frontend:80 {
            header_up Host {host}
        }
    }
    
    # API routes (includes WebSocket support)
    handle /api* {
        reverse_proxy tracker-backend:8000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            # Force HTTP/1.1 for WebSocket support and large responses
            transport http {
                versions 1.1
            }
        }
    }
    
    # Default landing page
    reverse_proxy landing:80 {
        header_up Host {host}
    }
    
    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy no-referrer-when-downgrade
    }
}


